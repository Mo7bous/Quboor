<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorial Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
          integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
          integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
:root {
  --primary-color: #41464a;
  --secondary-color: #1F262A;
  --text-color: #F2E9E4;
  --background-color: #f4f4f4;
}

        html, body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--secondary-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            text-align: justify;
            overflow-x: hidden;
        }


/* NAVBAR */
.top-nav {
  display: flex;
  align-items: center;
  background-color: var(--primary-color);
  color: var(--text-color);
  padding: 15px 20px;
  height: 50px;
  width: 100%;
  position: relative;
  box-sizing: border-box;
}

.top-nav h1 {
  flex-grow: 0;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
  display: flex;
  align-items: center;
}

.logo {
  height: 40px;
  width: auto;
}

.menu-btn {
  font-size: 24px;
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  z-index: 1; /* Ensure it's clickable */
}

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        
.nav-right-controls {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 15px;
}

.dark-mode-toggle-btn {
    position: relative;
    right: auto;
    top: auto;
    transform: none;
    font-size: 22px;
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    padding: 5px;
}

/* SIDEBAR */
.sidebar {
  height: 100%;
  width: 280px;
  position: fixed;
  top: 0;
  left: -280px;
  background-color: var(--primary-color);
  overflow-x: hidden;
  transition: 0.4s;
  padding-top: 60px;
  z-index: 1001; /* Match old z-index */
}

.sidebar a {
  padding: 10px 25px;
  font-size: 18px;
  color: var(--text-color);
  display: flex;
  align-items: center;
  text-decoration: none;
  border-bottom: 1px solid var(--primary-color);
  transition: background-color 0.3s;
}

.sidebar a:hover {
    background-color: var(--primary-color);
}

.sidebar a i {
  margin-right: 15px;
}

.closebtn {
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 30px;
  color: var(--text-color);
  cursor: pointer;
}

#main {
    padding: 10px 20px 80px;
    margin-top: 10px; /* Adjust based on new banner height */
}

#map {
    height: 250px;
    width: 100%;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.search-explanation {
    background-color: #e9f5ff;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #333;
}

.search-explanation p {
    margin: 5px 0;
}

.search-explanation strong {
    color: #0056b3;
}

.search-container {
    margin-bottom: 20px;
}

#searchInput {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

#death-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.death-card {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 15px;
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
    position: relative;
}

.death-card:hover {
    transform: translateY(-5px);
}

.card-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.card-actions button {
    background: none;
    border: none;
    color: #777;
    cursor: pointer;
    font-size: 16px;
    padding: 5px;
}
.card-actions button:hover {
    color: #333;
}


.death-card-info {
    display: flex;
    align-items: center;
}

.death-card-image {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 15px;
    border: 2px solid #eee;
}

.death-card-details h3 {
    margin: 0 0 5px 0;
    font-size: 1.2em;
    color: #333;
}

.info-items {
    display: flex;
    gap: 15px;
    margin-bottom: 5px;
}

.info-item {
    display: flex;
    align-items: center;
    font-size: 0.9em;
    color: #555;
}

.info-item i {
    margin-right: 5px;
    color: #777;
}

.info-item p {
    margin: 0;
}

mark {
    background-color: #ffda79;
    padding: 0.1em;
}

.match-percentage {
    position: absolute;
    top: 5px;
    left: 5px;
    background-color: rgba(40, 167, 69, 0.8);
    color: white;
    padding: 3px 6px;
    border-radius: 3px;
    font-size: 0.8em;
}

.popup {
    display: none; 
    position: fixed; 
    z-index: 1002; 
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto; 
    background-color: rgba(0,0,0,0.6);
}

.popup-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 30px;
    border-radius: 8px;
    width: 80%;
    max-width: 700px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
}

.popup-close {
    color: #aaa;
    float: right;
    font-size: 32px;
    font-weight: bold;
    position: absolute;
    top: 10px;
    right: 20px;
}

.popup-close:hover,
.popup-close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

#profileContent {
    margin-bottom: 20px; 
}

.profile-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.profile-image {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 10px;
    border: 4px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.profile-header h2 {
    margin: 10px 0 5px 0;
    color: #333;
}

.profile-description {
    font-size: 1em;
    color: #666;
    margin-top: 5px;
    margin-bottom: 15px;
    font-style: italic;
    max-width: 80%;
    margin-left: auto;
    margin-right: auto;
}

.profile-body {
    /* container for sections below header */
}

.profile-section {
    margin-bottom: 25px;
}
.profile-section:last-child {
    margin-bottom: 0;
}

.profile-section h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--primary-color);
    font-size: 1.1em;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
    font-weight: 700;
}

.profile-details .profile-item {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    font-size: 1em;
    color: #444;
}

.profile-details .profile-item i {
    width: 20px; 
    margin-right: 15px;
    color: var(--primary-color); 
    text-align: center;
}
.profile-details .profile-item span {
    flex-grow: 1;
}

.relatives-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 15px;
}

.relative-card {
    background-color: #f9f9f9;
    border-radius: 8px;
    text-align: center;
    padding: 10px;
    border: 1px solid #eee;
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.2s;
}

.relative-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.relative-image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 8px;
    border: 2px solid #ddd;
}

.relative-name {
    font-size: 0.9em;
    font-weight: 500;
    color: #333;
}

.profile-gallery-section {
    border-top: none;
    padding-top: 0;
    margin-top: 25px;
}

.profile-gallery-section h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--primary-color);
    font-size: 1.1em;
    text-align: left;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
    font-weight: 700;
}

.gallery-images-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
    max-height: 300px; 
    overflow-y: auto;
    padding: 5px;
    background-color: #f9f9f9;
    border-radius: 4px;
}

.gallery-images-container img {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
    cursor: pointer; 
    transition: opacity 0.2s;
}

.gallery-images-container img:hover {
    opacity: 0.8;
}

.gallery-images-container p {
    text-align: center;
    color: #777;
    grid-column: 1 / -1; 
}

.gallery-upload {
    text-align: center;
}

.upload-btn {
    background-color: #0275d8;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
    display: inline-block;
    font-size: 0.9em;
}

.upload-btn:hover {
    background-color: #025aa5;
}

.upload-btn i {
    margin-right: 8px;
}

.profile-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
}

.profile-uid {
    margin-top: 15px;
    font-size: 0.9em;
    color: #888;
    font-family: 'Courier New', Courier, monospace;
    font-weight: bold;
}

.profile-directions-btn {
    background-color: #007bff;
    border: none;
    color: white;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 0; /* Let flex gap handle spacing */
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}

.profile-directions-btn:hover {
    background-color: #0056b3;
}

.profile-directions-btn i {
    margin-right: 8px;
}

.profile-share-btn {
    background-color: #25D366; /* WhatsApp Green */
    border: none;
    color: white;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 0;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}

.profile-share-btn:hover {
    background-color: #1DA851; /* Darker WhatsApp Green */
}

.profile-share-btn i {
    margin-right: 8px;
}

/* Report Error Button */
.report-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
}

.report-error-btn {
    background-color: #c9302c;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 500;
    display: inline-block;
    text-align: center;
    transition: background-color 0.3s;
}

.report-error-btn:hover {
    background-color: #ac2925;
}

.report-error-btn i {
    margin-right: 8px;
}

/* Image Viewer Modal Styles */
#imageViewerPopup {
    background-color: rgba(0,0,0,0.9);
    z-index: 1003;
    align-items: center;
    justify-content: center;
}

.image-viewer-content {
    margin: auto;
    display: block;
    max-width: 80vw;
    max-height: 80vh;
}

.image-viewer-close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
}

.image-viewer-close:hover,
.image-viewer-close:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

/* Next & previous buttons */
#imageViewerPopup .prev, #imageViewerPopup .next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -22px;
  color: white;
  font-weight: bold;
  font-size: 20px;
  transition: 0.6s ease;
  border-radius: 0 3px 3px 0;
  user-select: none;
  background-color: rgba(0,0,0,0.3);
}

/* Position the "next button" to the right */
#imageViewerPopup .next {
  right: 0;
  border-radius: 3px 0 0 3px;
}

#imageViewerPopup .prev {
    left: 0;
}

/* On hover, add a black background color with a little bit of transparency */
#imageViewerPopup .prev:hover, #imageViewerPopup .next:hover {
  background-color: rgba(0,0,0,0.6);
}

/* --- Quran Audio Player --- */
#audio-player-container {
    width: 100%;
    background-color: var(--primary-color); /* même couleur que la bannière */
    color: var(--text-color);
    padding: 5px 5px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
}

.player-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    max-width: none;
    margin: 0 auto;
}

#play-pause-btn {
    background: none;
    border: 1px solid var(--text-color);
    color: var(--text-color);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

#play-pause-btn:hover {
    background-color: var(--text-color);
    color: var(--primary-color);
}

#play-pause-btn .fa-play {
    margin-left: 2px; /* To center the play icon better */
}

.player-info {
    text-align: center;
    flex-grow: 1;
    margin: 0 15px;
    overflow: hidden;
    white-space: nowrap;
}

.player-info span {
    font-weight: bold;
    display: block;
    font-size: 0.9em;
}

.player-info small {
    font-size: 0.75em;
    opacity: 0.8;
}

.volume-control {
    display: flex;
    align-items: center;
}

.volume-control i {
    margin-right: 8px;
    font-size: 1em;
}

#volume-slider {
    -webkit-appearance: none;
    appearance: none;
    width: 70px;
    height: 3px;
    background: #5a6268;
    border-radius: 5px;
    outline: none;
    transition: opacity .2s;
    cursor: pointer;
}

#volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    background: var(--text-color);
    cursor: pointer;
    border-radius: 50%;
}

#volume-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    background: var(--text-color);
    cursor: pointer;
    border-radius: 50%;
    border: none;
}

/* --- Dark Mode Styles --- */
body.dark-mode {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

body.dark-mode .top-nav {
    background-color: #1F262A;
}

body.dark-mode .sidebar {
    background-color: #111;
}

body.dark-mode .sidebar a:hover {
    background-color: #1F262A;
}

body.dark-mode #map {
}

body.dark-mode .search-explanation {
    background-color: #2c3e50;
    border-left-color: #3498db;
    color: #ecf0f1;
}

body.dark-mode .search-explanation strong {
    color: #5dade2;
}

body.dark-mode #searchInput {
    background-color: #333;
    color: #eee;
    border-color: #555;
}

body.dark-mode .death-card {
    background-color: #2b2b2b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    border: 1px solid #444;
}

body.dark-mode .death-card-details h3,
body.dark-mode .relative-name {
    color: #f2f2f2;
}

body.dark-mode .info-item,
body.dark-mode .info-item p {
    color: #b0b0b0;
}

body.dark-mode .info-item i {
    color: #888;
}

body.dark-mode mark {
    background-color: #b38600;
    color: #fff;
}

body.dark-mode .popup-content {
    background-color: #252525;
    color: #eee;
}

body.dark-mode .popup-close {
    color: #888;
}
body.dark-mode .popup-close:hover {
    color: #eee;
}

body.dark-mode .profile-header {
    border-bottom-color: #444;
}

body.dark-mode .profile-image {
    border-color: #444;
}

body.dark-mode .profile-header h2 {
    color: #f5f5f5;
}

body.dark-mode .profile-description {
    color: #ccc;
}

body.dark-mode .profile-section h4 {
    color: #5dade2;
    border-bottom-color: #5dade2;
}

body.dark-mode .profile-details .profile-item {
    color: #ddd;
}

body.dark-mode .profile-details .profile-item i {
    color: #5dade2;
}

body.dark-mode .relative-card {
    background-color: #333;
    border-color: #444;
}

body.dark-mode .gallery-images-container {
    background-color: #222;
}

body.dark-mode .gallery-images-container img {
    border-color: #555;
}

body.dark-mode .report-section {
    border-top-color: #444;
}

body.dark-mode .report-error-btn:hover {
    background-color: #c0392b;
}

body.dark-mode #audio-player-container {
    background-color: transparent;
    box-shadow: none;
}

body.dark-mode #play-pause-btn {
    border-color: #e0e0e0;
    color: #e0e0e0;
}
body.dark-mode #play-pause-btn:hover {
    background-color: #e0e0e0;
    color: #1F262A;
}
body.dark-mode #volume-slider {
    background: #444;
}
body.dark-mode #volume-slider::-webkit-slider-thumb {
    background: #e0e0e0;
}
body.dark-mode #volume-slider::-moz-range-thumb {
    background: #e0e0e0;
}
    </style>
    <script type="importmap">
    {
      "imports": {
        "leaflet": "https://unpkg.com/leaflet@1.9.3/dist/leaflet-src.esm.js"
      }
    }
    </script>
</head>
<body>
    <div class="top-nav">
        <button class="menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <h1>
<img src="img/logotitre.png" alt="Logo Quboor" class="logo">
        </h1>
        <div class="nav-right-controls">
            <button id="darkModeToggle" class="dark-mode-toggle-btn">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

                <div id="audio-player-container">
                <div class="player-controls">
                    <button id="play-pause-btn" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="volume-control">
                        <i class="fas fa-volume-up"></i>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.8" title="Volume">
                    </div>
                </div>
                <audio id="quran-player" src="audio/ba9ara.mp3" preload="none"></audio>
            </div>

    <div id="mySidebar" class="sidebar">
        <span class="closebtn">&times;</span>
        <a href="search.html"><i class="fas fa-search"></i>Recherche</a>
        <a href="new.html"><i class="fas fa-user-plus"></i>Ajouter</a>
        <a href="mission.html"><i class="fas fa-tasks"></i>Missions</a>
        <a href="dons.html"><i class="fas fa-info-circle"></i>Projets et Dons</a>
        <a href="joinus.html"><i class="fas fa-users"></i>Rejoins-nous</a>
        <a href="tools.html"><i class="fas fa-tools"></i>Outils</a>
        <a href="contactus.html"><i class="fas fa-envelope"></i>Contact</a>    
        <a href="index.html"><i class="fas fa-home"></i>Accueil</a>
    </div>

    <div id="main">
        <div id="map"></div>
        <div class="search-explanation">
            <p><strong>Comment rechercher ?</strong> Correspondances dans tous les champs (nom, prénom, dates, etc.). Chaque champ contenant un terme de votre recherche augmente le pourcentage de pertinence.</p>
            <p><strong>Exemple :</strong> Taper "Mohammed Rabat 1978" trouvera les personnes nommées "Mohammed" ainsi que celles liées à "Rabat" et autres filtres , accordant un score plus élevé à celles qui correspondent aux termes recherchés.</p>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Recherchez par nom, date ou autres détails">
        </div>
        <div id="death-cards-container"></div>
    </div>
    <div id="profilePopup" class="popup">
        <div class="popup-content">
            <span class="popup-close">&times;</span>
            <div id="profileContent">
                <!-- Profile details will be loaded here -->
            </div>
            <div class="profile-gallery-section">
                <h4>Galerie d'images</h4>
                <div id="profileGalleryImages" class="gallery-images-container">
                </div>
            </div>
        </div>
    </div>
    <div id="imageViewerPopup" class="popup">
        <span class="popup-close image-viewer-close">&times;</span>
        <a class="prev">&#10094;</a>
        <a class="next">&#10095;</a>
        <img class="image-viewer-content" id="fullSizeImage">
    </div>
    <script type="module">
import * as L from 'leaflet';

L.Icon.Default.imagePath = 'https://unpkg.com/leaflet@1.9.3/dist/images/';

const deathEntries = [
    {uid:"5I2J8K1L",familyName:"Stouki",firstName:"Abdellah",dob:"1946",birthplace:"Marrakech",dod:"2022-07-12",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/5I2J8K1L/1.jpeg","users/users/5I2J8K1L/2.jpeg","users/users/5I2J8K1L/3.jpeg","users/users/5I2J8K1L/4.jpeg","users/users/5I2J8K1L/5.jpeg"],description:"Journaliste engagé et homme de plume, il a marqué de son empreinte la presse marocaine par son intégrité et sa passion pour la vérité",cemetery:"Cimetière Chouhada de Rabat",profession:"Journaliste",relatives:[]},
    {uid:"3M7N9O4P",familyName:"Choubi",firstName:"Mohamed",dob:"1963-12-01",birthplace:"Marrakech",dod:"2025-05-02",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/3M7N9O4P/1.jpeg","users/users/3M7N9O4P/2.jpeg","users/users/3M7N9O4P/3.jpeg","users/users/3M7N9O4P/4.jpeg","users/users/3M7N9O4P/5.jpeg"],description:"Acteur et intellectuel engagé",cemetery:"Cimetière Chouhada - Rabat",profession:"Acteur",relatives:[]},
    {uid:"LDUTYNO8",familyName:"Moatassim",firstName:"Mohamed",dob:"1956-01-01",birthplace:"Settat",dod:"2023-06-05",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/LDUTYNO8/1.jpeg","users/users/LDUTYNO8/2.jpeg","users/users/LDUTYNO8/3.jpeg","users/users/LDUTYNO8/4.jpeg","users/users/LDUTYNO8/5.jpeg"],description:"Conseiller du roi Mohammed VI et universitaire.",cemetery:"Cimetière Chouhada de Rabat",profession:"Conseiller royal & juriste",relatives:[]},
    {uid:"4LCX8KBM",familyName:"Jirari",firstName:"Abbès",dob:"1937-02-15",birthplace:"Rabat",dod:"2024-01-20",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/4LCX8KBM/1.jpeg","users/users/4LCX8KBM/2.jpeg","users/users/4LCX8KBM/3.jpeg","users/users/4LCX8KBM/4.jpeg","users/users/4LCX8KBM/5.jpeg"],description:"Intellectuel, conseiller royal et doyen de la littérature arabe.",cemetery:"Cimetière Chouhada de Rabat",profession:"Conseiller royal & universitaire",relatives:[]},
    {uid:"PD1GTHTU",familyName:"Saïl",firstName:"Noureddine",dob:"1947-01-01",birthplace:"Tanger",dod:"2020-12-15",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/PD1GTHTU/1.jpeg","users/users/PD1GTHTU/2.jpeg","users/users/PD1GTHTU/3.jpeg","users/users/PD1GTHTU/4.jpeg","users/users/PD1GTHTU/5.jpeg"],description:"Critique cinématographique, ex‑patron de 2M et du CCM.",cemetery:"Cimetière Chouhada de Rabat",profession:"Critique & enseignant",relatives:[]},
    {uid:"R1E8KTZ3",familyName:"Benkhaldoun",firstName:"Soumia",dob:"1963-03-13",birthplace:"Marrakech",dod:"2023-06-28",deathplace:"Harhoura",location:"34.02920504233782, -6.844813985431729",images:["users/users/R1E8KTZ3/1.jpeg","users/users/R1E8KTZ3/2.jpeg","users/users/R1E8KTZ3/3.jpeg","users/users/R1E8KTZ3/4.jpeg","users/users/R1E8KTZ3/5.jpeg"],description:"Ancienne ministre, professeure et militante engagée pour les droits des femmes.",cemetery:"Cimetière Chouhada de Rabat",profession:"Ministre & Universitaire",relatives:[]},
    {uid:"12QQAWUR",familyName:"Radi",firstName:"Abdelouahed",dob:"1935-04-01",birthplace:"Salé",dod:"2023-03-26",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/12QQAWUR/1.jpeg","users/users/12QQAWUR/2.jpeg","users/users/12QQAWUR/3.jpeg","users/users/12QQAWUR/4.jpeg","users/users/12QQAWUR/5.jpeg"],description:"Ancien président de la Chambre des Représentants et ex‑Premier secrétaire de l’USFP.",cemetery:"Cimetière Chouhada de Rabat",profession:"Homme politique & professeur",relatives:[]},
    {uid:"6Q1R5S2T",familyName:"Bouhlal",firstName:"Mouhcine",dob:"1975-01-30",birthplace:"Rabat",dod:"2023-01-15",deathplace:"Rabat",location:"34.03035867959946, -6.843429048160808",images:["users/users/6Q1R5S2T/1.jpeg","users/users/6Q1R5S2T/2.jpeg","users/users/6Q1R5S2T/3.jpeg","users/users/6Q1R5S2T/4.jpeg","users/users/6Q1R5S2T/5.jpeg"],description:"Leader d’une génération, il a marqué le football marocain par son talent, sa vision du jeu et son engagement exemplaire sur et en dehors du terrain.",cemetery:"Cimetière Chouhada de Rabat",profession:"Sportif",relatives:[8,9,10]},
    {uid:"P9I7Q1RD",familyName:"Bouhlal",firstName:"Abdel Karim",dob:"1960-11-05",birthplace:"Rabat",dod:"2021-05-20",deathplace:"Rabat",location:"34.03077574369565, -6.838867787876438",images:["users/users/P9I7Q1RD/1.jpeg","users/users/P9I7Q1RD/2.jpeg","users/users/P9I7Q1RD/3.jpeg","users/users/P9I7Q1RD/4.jpeg","users/users/P9I7Q1RD/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Musicien",relatives:[7,9,10]},
    {uid:"X8G2TQ7K",familyName:"Bouhlal",firstName:"Abdel Fettah",dob:"n/a",birthplace:"Rabat",dod:"2001-04-20",deathplace:"Rabat",location:"34.03065405853028, -6.838245091791529",images:["users/users/X8G2TQ7K/1.jpeg","users/users/X8G2TQ7K/2.jpeg","users/users/X8G2TQ7K/3.jpeg","users/users/X8G2TQ7K/4.jpeg","users/users/X8G2TQ7K/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Employer",relatives:[7,8]},
    {uid:"URU136EV",familyName:"Lhrizi",firstName:"Mehjouba",dob:"1978-09-05",birthplace:"Nador",dod:"2023-03-11",deathplace:"Rabat",location:"34.03076153229848, -6.8387874054214155",images:["users/users/URU136EV/1.jpeg","users/users/URU136EV/2.jpeg","users/users/URU136EV/3.jpeg","users/users/URU136EV/4.jpeg","users/users/URU136EV/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Femme au foyer",relatives:[7,8,10]},
    {uid:"HDKMLMKL",familyName:"Bensalem",firstName:"Hassan",dob:"1978-09-05",birthplace:"Tanger",dod:"2023-03-11",deathplace:"Rabat",location:"34.03089883028951, -6.841257164662843",images:["users/users/HDKMLMKL/1.jpeg","users/users/HDKMLMKL/2.jpeg","users/users/HDKMLMKL/3.jpeg","users/users/HDKMLMKL/4.jpeg","users/users/HDKMLMKL/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Sportif",relatives:[12,13]},
    {uid:"HDKMLMKL",familyName:"Bensalem",firstName:"Fatna",dob:"1978-09-05",birthplace:"Nador",dod:"2023-03-11",deathplace:"Rabat",location:"34.03038428663063, -6.840810491371483",images:["users/users/4SMK7LMK/1.jpeg","users/users/4SMK7LMK/2.jpeg","users/users/4SMK7LMK/3.jpeg","users/users/4SMK7LMK/4.jpeg","users/users/4SMK7LMK/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Femme au foyer",relatives:[11,13]},
    {uid:"4LMKHDKM",familyName:"Bensalem",firstName:"Rachid",dob:"1978-09-05",birthplace:"Rabat",dod:"2023-03-11",deathplace:"Meknes",location:"34.029569894590644, -6.84274458669287",images:["users/users/4LMKHDKM/1.jpeg","users/users/4LMKHDKM/2.jpeg","users/users/4LMKHDKM/3.jpeg","users/users/4LMKHDKM/4.jpeg","users/users/4LMKHDKM/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Cuisiner",relatives:[11,12]},
    {uid:"M8X2V5LK",familyName:"Elhanchi Elamrani",firstName:"Sidi Rachid",dob:"1945-11-17",birthplace:"n/a",dod:"2010-07-12",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/M8X2V5LK/1.jpeg","users/users/M8X2V5LK/2.jpeg","users/users/M8X2V5LK/3.jpeg","users/users/M8X2V5LK/4.jpeg","users/users/M8X2V5LK/5.jpeg"],description:"Rust in vrede onze zeer geliefde, echtgenoot, vader, opa en broer",cemetery:"Cimetière Chouhada de Rabat",profession:"n/a",relatives:[]},
    {uid:"F6J3A9B7",familyName:"Tazi",firstName:"Sidi Abdesselam",dob:"n/a",birthplace:"n/a",dod:"2010-07-31",deathplace:"Paris",location:"34.02920504233782, -6.844813985431729",images:["users/users/F6J3A9B7/1.jpeg","users/users/F6J3A9B7/2.jpeg","users/users/F6J3A9B7/3.jpeg","users/users/F6J3A9B7/4.jpeg","users/users/F6J3A9B7/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"n/a",relatives:[]},
    {uid:"8A7B3C2D",familyName:"Mouaz",firstName:"Amina",dob:"n/a",birthplace:"n/a",dod:"2024-03-14",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/8A7B3C2D/1.jpeg","users/users/8A7B3C2D/2.jpeg","users/users/8A7B3C2D/3.jpeg","users/users/8A7B3C2D/4.jpeg","users/users/8A7B3C2D/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"n/a",relatives:[]},
    {uid:"PTIKTQJP",familyName:"Rafii",firstName:"Mohammed",dob:"n/a",birthplace:"n/a",dod:"2021-11-20",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/PTIKTQJP/1.jpeg","users/users/PTIKTQJP/2.jpeg","users/users/PTIKTQJP/3.jpeg","users/users/PTIKTQJP/4.jpeg","users/users/PTIKTQJP/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"n/a",relatives:[]},
    {uid:"9F4E1G6H",familyName:"Sebich",firstName:"Abdelali",dob:"n/a",birthplace:"n/a",dod:"1987-12-04",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/9F4E1G6H/1.jpeg","users/users/9F4E1G6H/2.jpeg","users/users/9F4E1G6H/3.jpeg","users/users/9F4E1G6H/4.jpeg","users/users/9F4E1G6H/5.jpeg"],description:"Ô Dieu, accorde-lui ta miséricorde et une place dans ton vaste paradis.",cemetery:"Cimetière Chouhada de Rabat",profession:"Enseignante",relatives:[]},
    {uid:"7X2G9LQH",familyName:"Bendaddouch",firstName:"Mohamed",dob:"n/a",birthplace:"n/a",dod:"2023-11-20",deathplace:"Rabat",location:"34.02920504233782, -6.844813985431729",images:["users/users/7X2G9LQH/1.jpeg","users/users/7X2G9LQH/2.jpeg","users/users/7X2G9LQH/3.jpeg","users/users/7X2G9LQH/4.jpeg","users/users/7X2G9LQH/5.jpeg"],description:"Journaliste, figure emblématique de la radio nationale, directeur de la radio entre 1974 et 1986, conseiller en communication à l'Organisation de la coopération islamique (OCI).",cemetery:"Cimetière Chouhada de Rabat",profession:"Journaliste & directeur radio",relatives:[]},

];

const favoriteEntries = []; 

const markers = {};
let map; 
let markerClusterGroup; // For MarkerCluster plugin
let currentProfileIndex = -1; // To keep track of the currently open profile
let currentImageIndex = 0;
let currentGalleryImages = [];

function initializeMap() {
    map = L.map('map').setView([33.5731, -7.5898], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(map);
    // Initialize MarkerCluster group
    if (L.markerClusterGroup) {
        markerClusterGroup = L.markerClusterGroup();
        map.addLayer(markerClusterGroup);
    }
}

// Helper function to format date from YYYY-MM-DD to DD-MM-YYYY
function formatDateToDDMMYYYY(dateString) {
    if (!dateString || typeof dateString !== 'string') return 'N/A';
    const parts = dateString.split('-');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    return dateString; // Fallback if format is unexpected
}

const searchInputDOM = document.getElementById('searchInput');

window.onclick = function(event) {
    const profilePopup = document.getElementById('profilePopup');
    if (event.target == profilePopup) {
        closePopup();
    }
}

function highlightText(text, searchTerms) {
    if (!text) return '';
    if (!searchTerms.length) return text;
    const regex = new RegExp(`(${searchTerms.join('|').replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

function calculateMatchPercentage(entry, searchTerms) {
    if (searchTerms.length === 0) return 0;

    const entryFields = [
        entry.familyName,
        entry.firstName,
        formatDateToDDMMYYYY(entry.dob),
        formatDateToDDMMYYYY(entry.dod),
        entry.birthplace,
        entry.deathplace,
        entry.description,
        entry.cemetery,
        entry.profession,
        entry.uid
    ].map(f => (f || '').toLowerCase());

    const totalFields = entryFields.length;
    const matchedFields = new Set();

    searchTerms.forEach(term => {
        const lowerCaseTerm = term.toLowerCase();
        entryFields.forEach((field, index) => {
            if (field.includes(lowerCaseTerm)) {
                matchedFields.add(index);
            }
        });
    });

    const score = matchedFields.size;
    const percentage = (score / totalFields) * 100;
    
    // As requested, from 0 to 99.5%
    return Math.min(percentage, 99.5);
}

function createCard(entry, index, searchTerms, matchPercentage) {
    const card = document.createElement("div");
    card.className = "death-card";
    
    const dobFormatted = formatDateToDDMMYYYY(entry.dob);
    const dodFormatted = formatDateToDDMMYYYY(entry.dod);
    const primaryImage = entry.images && entry.images.length > 0 ? entry.images[0] : 'default_profile_image.png';

    const descriptionText = entry.description || '';
    const truncatedDescription = descriptionText.length > 20 ? descriptionText.substring(0, 20) + '...' : descriptionText;

    card.innerHTML = `
        <div class="card-actions">
            <button title="Info" class="info-btn"><i class="fas fa-info-circle"></i></button>
        </div>
        <div class="death-card-info">
            <img src="${primaryImage}" alt="${entry.familyName} ${entry.firstName}" class="death-card-image" onerror="this.src='default_profile_image.png';">
            <div class="death-card-details">
                <h3>${highlightText(entry.familyName + ' ' + entry.firstName, searchTerms)}</h3>
                <div class="info-items">
                    <div class="info-item"><i class="fas fa-birthday-cake"></i><p>${highlightText(dobFormatted, searchTerms)}</p></div>
                    <div class="info-item"><i class="fas fa-praying-hands"></i><p>${highlightText(dodFormatted, searchTerms)}</p></div>
                </div>
                <div class="info-item"><i class="fas fa-briefcase"></i><p>${highlightText(entry.profession || '', searchTerms)}</p></div>
                <div class="info-item"><i class="fas fa-info-circle"></i><p>${highlightText(truncatedDescription, searchTerms)}</p></div>
            </div>
        </div>
        ${matchPercentage > 0 ? `<div class="match-percentage">${matchPercentage.toFixed(1)}%</div>` : ''}
    `;

    card.querySelector('.info-btn').addEventListener('click', (event) => showInfo(index, event));
    
card.addEventListener('click', (event) => {
    if (event.target.closest('.card-actions')) return;

    const mapElement = document.getElementById('map');
    if (mapElement) {
        const rect = mapElement.getBoundingClientRect();
        const offsetTop = window.scrollY + rect.top - 20; // 👈 Ajoute un "gap" de 80px
        window.scrollTo({
            top: offsetTop,
            behavior: 'smooth'
        });
    }

    showLocationOnMap(entry, index);
});
    return card;
}

function filterCards() {
    const searchInput = searchInputDOM.value.toLowerCase();
    const searchTerms = searchInput.split(' ').filter(term => term.trim() !== '');
    const container = document.getElementById("death-cards-container");
    container.innerHTML = "";

    const entriesToShow = [...deathEntries, ...favoriteEntries]; 

    // Calculate match percentage for each entry
    const scoredEntries = entriesToShow.map(entry => ({
        entry,
        matchPercentage: calculateMatchPercentage(entry, searchTerms)
    }));

    // Sort entries by their match percentage in descending order
    scoredEntries.sort((a, b) => b.matchPercentage - a.matchPercentage);

    // Clear existing markers if using MarkerCluster
    if (markerClusterGroup) {
        markerClusterGroup.clearLayers();
    }

    scoredEntries.forEach(({ entry, matchPercentage }) => { 
        const actualIndexInDeathEntries = deathEntries.findIndex(de => de === entry);

        // Only show cards that have a match if a search is being performed
        if (searchTerms.length > 0 && matchPercentage === 0) {
            // Do not display this card
        } else {
            const card = createCard(entry, actualIndexInDeathEntries, searchTerms, matchPercentage);
            container.appendChild(card);
        }

        if (entry.location) {
            const [lat, lng] = entry.location.split(',').map(coord => parseFloat(coord.trim()));
            if (!isNaN(lat) && !isNaN(lng)) {
                 if (!markers[actualIndexInDeathEntries]) {
                    markers[actualIndexInDeathEntries] = L.marker([lat, lng]);
                }
                 markers[actualIndexInDeathEntries].on('click', () => showLocationOnMap(entry, actualIndexInDeathEntries));
                 // Add marker to cluster group instead of map directly
                 if (markerClusterGroup) {
                    markerClusterGroup.addLayer(markers[actualIndexInDeathEntries]);
                 } else {
                    markers[actualIndexInDeathEntries].addTo(map); // Fallback if plugin fails
                 }
            }
        }
    });
}

function renderProfileGallery(images) {
    const galleryContainer = document.getElementById('profileGalleryImages');
    galleryContainer.innerHTML = ''; // Clear existing images

    const displayImages = [];
    const numImagesToDisplay = 5;

    if (images && images.length > 0) {
        for (let i = 0; i < numImagesToDisplay; i++) {
            displayImages.push(images[i % images.length] || 'default_profile_image.png');
        }
    } else {
        for (let i = 0; i < numImagesToDisplay; i++) {
            displayImages.push('default_profile_image.png');
        }
    }
    
    displayImages.forEach((imageSrc, index) => {
        const imgElement = document.createElement('img');
        imgElement.src = imageSrc;
        imgElement.alt = "Galerie d'image";
        imgElement.onerror = function() { this.src = 'default_profile_image.png'; };
        imgElement.addEventListener('click', () => {
            openImageViewer(displayImages, index);
        });
        galleryContainer.appendChild(imgElement);
    });

    if (displayImages.length === 0) {
        galleryContainer.innerHTML = '<p>Aucune image dans la galerie.</p>';
    }
}

function showInfo(index, event) {
    if (event) event.stopPropagation();
    currentProfileIndex = index; // Set current profile index
    const entry = deathEntries[index];
    if (!entry) return;

    // Remove existing report section to avoid duplicates when opening a new profile
    const existingReportSection = document.querySelector('#profilePopup .popup-content .report-section');
    if (existingReportSection) {
        existingReportSection.remove();
    }

    const primaryImage = entry.images && entry.images.length > 0 ? entry.images[0] : 'default_profile_image.png';

    let directionsButtonHTML = '';
    if (entry.location) {
        const [lat, lng] = entry.location.split(',').map(coord => parseFloat(coord.trim()));
        if (!isNaN(lat) && !isNaN(lng)) {
            directionsButtonHTML = `
                <button onclick="window.openDirections(${lat}, ${lng})" class="profile-directions-btn">
                    <i class="fas fa-directions"></i> Itinéraire
                </button>
            `;
        }
    }

    const shareButtonHTML = `
        <button onclick="window.shareProfile(${index})" class="profile-share-btn">
            <i class="fab fa-whatsapp"></i> Partager
        </button>
    `;

    const profileContent = document.getElementById('profileContent');
    profileContent.innerHTML = `
        <div class="profile-header">
            <img src="${primaryImage}" alt="${entry.familyName} ${entry.firstName}" class="profile-image" onerror="this.src='default_profile_image.png';">
            <h2>${entry.familyName} ${entry.firstName}</h2>
            <p class="profile-description">"${entry.description || ''}"</p>
            <div class="profile-actions">
                ${directionsButtonHTML}
                ${shareButtonHTML}
            </div>
            ${entry.uid ? `<div class="profile-uid">UID: ${entry.uid}</div>` : ''}
        </div>
        <div class="profile-body">
            <div class="profile-section">
                <h4>Informations</h4>
                <div class="profile-details">
                    <div class="profile-item"><i class="fas fa-birthday-cake"></i><span><strong>Date de naissance:</strong> ${entry.dob ? formatDateToDDMMYYYY(entry.dob) : 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-map-marker-alt"></i><span><strong>Lieu de naissance:</strong> ${entry.birthplace || 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-praying-hands"></i><span><strong>Date de décès:</strong> ${entry.dod ? formatDateToDDMMYYYY(entry.dod) : 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-map-marker-alt"></i><span><strong>Lieu de décès:</strong> ${entry.deathplace || 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-church"></i><span><strong>Cimetière:</strong> ${entry.cemetery || 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-briefcase"></i><span><strong>Profession:</strong> ${entry.profession || 'N/A'}</span></div>
                    <div class="profile-item"><i class="fas fa-map-pin"></i><span><strong>Localisation:</strong> ${entry.location || 'N/A'}</span></div>
                </div>
            </div>
            <div class="profile-section" id="relativesSection">
                <!-- Relatives will be injected here -->
            </div>
        </div>
    `;

    // Find and render relatives
    const relativeIndices = entry.relatives || [];

    const relativesSection = profileContent.querySelector('#relativesSection');
    if (relativeIndices.length > 0 && relativesSection) {
        let relativesHTML = '<h4>Parents et proches</h4><div class="relatives-container">';
        relativeIndices.forEach(relativeIndex => {
            const relative = deathEntries[relativeIndex];
            if (relative) {
                const relativePrimaryImage = relative.images && relative.images.length > 0 ? relative.images[0] : 'default_profile_image.png';
                relativesHTML += `
                    <div class="relative-card" onclick="window.showRelativeProfile(${relativeIndex})">
                        <img src="${relativePrimaryImage}" alt="${relative.firstName} ${relative.familyName}" class="relative-image" onerror="this.src='default_profile_image.png';">
                        <div class="relative-name">${relative.firstName} ${relative.familyName}</div>
                    </div>
                `;
            }
        });
        relativesHTML += '</div>';
        relativesSection.innerHTML = relativesHTML;
    }

    renderProfileGallery(entry.images);

    // Add "Report Error" button at the bottom of the popup
    const reportBtn = document.createElement('button');
    reportBtn.className = 'report-error-btn';
    reportBtn.innerHTML = `<i class="fas fa-envelope"></i> Signaler une erreur`;
    reportBtn.onclick = () => {
        const subject = `Erreur signalée pour ${entry.firstName} ${entry.familyName}`;
        const body = `Bonjour,

Je signale une erreur sur le profil de ${entry.firstName} ${entry.familyName}.

Voici les informations actuelles du profil :
------------------------------------------
Nom: ${entry.familyName || 'N/A'}
Prénom: ${entry.firstName || 'N/A'}
Date de naissance: ${entry.dob ? formatDateToDDMMYYYY(entry.dob) : 'N/A'}
Lieu de naissance: ${entry.birthplace || 'N/A'}
Date de décès: ${entry.dod ? formatDateToDDMMYYYY(entry.dod) : 'N/A'}
Lieu de décès: ${entry.deathplace || 'N/A'}
Profession: ${entry.profession || 'N/A'}
Description: "${entry.description || 'N/A'}"
Cimetière: ${entry.cemetery || 'N/A'}
Localisation: ${entry.location || 'N/A'}
------------------------------------------

Description de l'erreur:
[Veuillez décrire l'erreur ici]

Merci.`;
        window.location.href = `mailto:info@qubor.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    };
    const reportSection = document.createElement('div');
    reportSection.className = 'profile-section report-section';
    reportSection.appendChild(reportBtn);
    document.querySelector('#profilePopup .popup-content').appendChild(reportSection);

    document.getElementById('profilePopup').style.display = 'block';
}

function closePopup() {
    document.getElementById('profilePopup').style.display = 'none';
    currentProfileIndex = -1; // Reset current profile index
}

const profilePopupCloseButton = document.querySelector('#profilePopup .popup-close');
if (profilePopupCloseButton) {
    profilePopupCloseButton.addEventListener('click', closePopup);
}

// --- NEW FUNCTIONS FOR IMAGE VIEWER ---

function updateImageViewer() {
    if (currentGalleryImages.length > 0) {
        const fullSizeImage = document.getElementById('fullSizeImage');
        fullSizeImage.src = currentGalleryImages[currentImageIndex];
    }
}

function openImageViewer(images, index) {
    currentGalleryImages = images;
    currentImageIndex = index;
    const imageViewerPopup = document.getElementById('imageViewerPopup');
    imageViewerPopup.style.display = 'flex'; // Use flex for centering
    updateImageViewer();
}

function closeImageViewer() {
    document.getElementById('imageViewerPopup').style.display = 'none';
}

function showNextImage() {
    currentImageIndex = (currentImageIndex + 1) % currentGalleryImages.length;
    updateImageViewer();
}

function showPrevImage() {
    currentImageIndex = (currentImageIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
    updateImageViewer();
}

// --- END NEW FUNCTIONS ---

function showLocationOnMap(entry, index) {
    if (!entry.location) {
        console.warn("Entry has no location:", entry);
        return;
    }
    const [lat, lng] = entry.location.split(',').map(coord => parseFloat(coord.trim()));
    if (isNaN(lat) || isNaN(lng)) {
        console.warn("Invalid location coordinates for entry:", entry);
        return;
    }
    
    const marker = markers[index];
    if (!marker) return;

    const primaryImage = entry.images && entry.images.length > 0 ? entry.images[0] : 'default_profile_image.png';

    const popupContent = `
        <div style="text-align: center;">
            <img src="${primaryImage}" alt="${entry.familyName} ${entry.firstName}" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px; object-fit: cover;" onerror="this.src='default_profile_image.png';">
            <h3 style="margin: 0 0 10px 0;">${entry.familyName} ${entry.firstName}</h3>
            <div style="display: flex; justify-content: center; gap: 8px;">
                 <button onclick="window.openDirections(${lat}, ${lng})" style="background-color: #007bff; border: none; color: white; padding: 8px 12px; text-align: center; text-decoration: none; display: inline-block; font-size: 14px; cursor: pointer; border-radius: 5px;">
                    <i class="fas fa-directions" style="margin-right: 5px;"></i> Itinéraire
                </button>
                <button onclick="window.openProfile(${index})" style="background-color: #17a2b8; border: none; color: white; padding: 8px 12px; text-align: center; text-decoration: none; display: inline-block; font-size: 14px; cursor: pointer; border-radius: 5px;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i> Détails
                </button>
            </div>
        </div>
    `;

    marker.bindPopup(popupContent);

    if (markerClusterGroup) {
        markerClusterGroup.zoomToShowLayer(marker, () => {
            marker.openPopup();
        });
    } else {
        map.setView([lat, lng], 15);
        marker.openPopup();
    }
}

window.showRelativeProfile = function(index) {
    closePopup();
    setTimeout(() => {
        showInfo(index);
    }, 150);
}

window.openProfile = (index) => showInfo(index);

window.shareProfile = function(index) {
    const entry = deathEntries[index];
    if (!entry) return;

    const profileUrl = `${window.location.origin}${window.location.pathname}?entry=${index}`;
    const text = `Consultez le mémorial pour ${entry.firstName} ${entry.familyName}: ${profileUrl}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;

    window.open(whatsappUrl, '_blank');
}

window.openDirections = function(lat, lng) {
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    window.open(url, '_blank');
}

function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    // Expose Leaflet to global scope for plugins
    window.L = L;
    try {
        await loadScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js');
    } catch (e) {
        console.error("MarkerCluster plugin could not be loaded. Markers will not be clustered.");
    }

    initializeMap();

    const urlParams = new URLSearchParams(window.location.search);
    const entryIdStr = urlParams.get('entry');
    if (entryIdStr) {
        const entryId = parseInt(entryIdStr, 10);
        if (!isNaN(entryId) && entryId >= 0 && entryId < deathEntries.length) {
            // Use a short timeout to ensure map and everything else is ready
            setTimeout(() => {
                showInfo(entryId);
            }, 100);
        }
    }

    if (searchInputDOM) {
        searchInputDOM.addEventListener('input', filterCards);
    }
    filterCards();

    // Sidebar toggle functionality
    const menuBtn = document.querySelector('.menu-btn');
    const closeBtn = document.querySelector('.closebtn');
    const sidebar = document.getElementById("mySidebar");

    const toggleNav = () => {
        if (sidebar.style.left === "0px") {
            sidebar.style.left = "-280px";
        } else {
            sidebar.style.left = "0px";
        }
    };

    if (menuBtn) menuBtn.addEventListener('click', toggleNav);
    if (closeBtn) closeBtn.addEventListener('click', toggleNav);

    // Image viewer listeners
    document.querySelector('#imageViewerPopup .image-viewer-close').addEventListener('click', closeImageViewer);
    document.querySelector('#imageViewerPopup .next').addEventListener('click', showNextImage);
    document.querySelector('#imageViewerPopup .prev').addEventListener('click', showPrevImage);

    document.getElementById('imageViewerPopup').addEventListener('click', (event) => {
        // Close if clicked on the background, but not on the image or controls
        if (event.target.id === 'imageViewerPopup') {
            closeImageViewer();
        }
    });

    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            const icon = darkModeToggle.querySelector('i');
            if (isDarkMode) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });
    }

    // Quran Audio Player Logic
    const audioPlayer = document.getElementById('quran-player');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const volumeSlider = document.getElementById('volume-slider');

    if(playPauseBtn && audioPlayer && volumeSlider) {
        const playIcon = playPauseBtn.querySelector('i');

        playPauseBtn.addEventListener('click', () => {
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.error("Error playing audio:", e));
            } else {
                audioPlayer.pause();
            }
        });

        audioPlayer.addEventListener('play', () => {
            playIcon.classList.remove('fa-play');
            playIcon.classList.add('fa-pause');
        });

        audioPlayer.addEventListener('pause', () => {
            playIcon.classList.remove('fa-pause');
            playIcon.classList.add('fa-play');
        });

        volumeSlider.addEventListener('input', () => {
            audioPlayer.volume = volumeSlider.value;
        });

        // Set initial volume from slider
        audioPlayer.volume = volumeSlider.value;
    }
});
</script>
</body>
</html>