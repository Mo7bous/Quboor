<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outils - Memorial Map</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
          integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #2C3E50;
            --secondary-color: #030404;
            --third-color: red;
            --fourth-color: yellow;
            --fifth-color: #2c3f53;/* Couleur du text de base en mode normal primaire fonce lighter */
            --sixth-color: #0f151b;  /* Couleur du text de base en mode normal primaire fonce */

            --text-color: #f9f4ea;  /* Couleur du text de base en mode normal  */
            --background-color: #f9f4ea;
            --accent-color: #f9f4ea;
        }

        .top-nav {
  display: flex;
  align-items: center;
  background-color: var(--primary-color);
  color: var(--text-color);
  padding: 15px 20px;
  height: 50px;
  width: 100%;
  position: relative;
  box-sizing: border-box;
}

        html, body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--secondary-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            text-align: justify;
            overflow-x: hidden;
        }

.top-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background-color: var(--primary-color);
  color: var(--text-color);
  height: 60px;
  width: 91%;
  margin: 20px auto 0 auto;
  border-radius: 8px;
  padding: 0 20px 0 32px; /* padding-left augmenté */
  box-sizing: border-box;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.top-nav h1 {
  flex-grow: 0;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
  display: flex;
  align-items: center;
}

    .logo {
      height: 40px;
      width: auto;
    }

    h1 {
    font-size: 1.5em;
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 20px;
    display: block;
    text-align: center;    }
.menu-btn {
  font-size: 24px;
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  z-index: 1; /* Ensure it's clickable */
}


    .nav-right-controls {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .dark-mode-toggle-btn {
      font-size: 22px;
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
    }

    .sidebar {
      height: 100%;
      width: 280px;
      position: fixed;
      top: 0;
      left: -280px;
      background-color: var(--primary-color);
      overflow-x: hidden;
      transition: 0.4s;
      padding-top: 60px;
      z-index: 1001;
    }

    .sidebar a {
      padding: 10px 25px;
      font-size: 18px;
      color: var(--text-color);
      display: flex;
      align-items: center;
      text-decoration: none;
      border-bottom: 1px solid var(--primary-color);
      transition: background-color 0.3s;
    }

    .sidebar a:hover {
      background-color: var(--primary-color);
    }

    .sidebar a i {
      margin-right: 15px;
    }

    .closebtn {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 30px;
      color: var(--text-color);
      cursor: pointer;
    }


        #main {
            padding: 20px;
            margin-top: 5px;
        }
        
        /* --- Quran Audio Player --- */
        #audio-player-container {
            background-color: transparent;
            color: var(--text-color);
            padding: 0;
            box-sizing: border-box;
            transition: none;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            max-width: none;
            margin: 0 auto;
        }

        #play-pause-btn {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #play-pause-btn:hover {
            background-color: var(--text-color);
            color: var(--primary-color);
        }
        
        #play-pause-btn .fa-play {
            margin-left: 2px;
        }

        .volume-control {
            display: flex;
            align-items: center;
        }

        .volume-control i {
            margin-right: 8px;
            font-size: 1em;
        }

        #volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 70px;
            height: 3px;
            background: #5a6268;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
            cursor: pointer;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--text-color);
            cursor: pointer;
            border-radius: 50%;
        }

        #volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: var(--text-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #1a1a1a;
            color: var(--text-color);
        }
        body.dark-mode .top-nav { background-color: var(--primary-color); }
        body.dark-mode .sidebar { background-color: var(--primary-color) }
        body.dark-mode .sidebar a:hover { background-color: var(--primary-color) }

        /* --- Tools Page Specific Styles --- */
        .tools-container {
            max-width: 900px;
            margin: 0px auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.1em;
            color: #555;
            max-width: 600px;
            margin: 0 auto;
        }

        .tool-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .tool-card i {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .tool-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #333;
        }

        .tool-card p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.5;
            margin: 0;
            flex-grow: 1;
        }

        /* --- Memento Mori Styles --- */
        #mementoMoriContainer {
            width: 100%;
        }
        .mm-step {
            display: none;
        }
        .mm-step.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        .mm-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group.form-group-inline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-group.form-group-inline label {
            margin-bottom: 0;
            flex-shrink: 0;
        }
        .form-group.form-group-inline input[type="date"] {
            flex-grow: 1;
            max-width: 130px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 0.9em;
        }
        .person-form {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .person-form h5 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        
        .form-group-icons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            min-height: 44px;
        }
        .form-group-icons label {
            margin-bottom: 0;
            font-weight: 500;
            font-size: 0.9em;
        }
        .icon-choices {
            display: flex;
            gap: 8px;
        }
        .icon-choice {
            background-color: lightgrey;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-choice:hover {
            border-color: var(--accent-color);
        }
        .icon-choice.selected {
            background-color: var(--primary-color);
            border-color: var(--accent-color);
            color: var(--text-color) ;
        }

        .date-selector {
            display: grid;
            grid-template-columns: 1fr 2fr 1.2fr;
            gap: 10px;
        }

        .mm-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        .mm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .mm-btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .mm-btn-primary:hover { background-color: #0056b3; }
        .mm-btn-secondary {
            background-color: var(--primary-color);
            color: white;
        }
         .mm-btn-secondary:hover { background-color: #0056b3; }

         .mm-btn-third {
            width: 100%;
            position: center;
            background-color: var(--primary-color);
            color: white;
        }
         .mm-btn-third:hover { background-color: #0056b3; }

        #mm-results {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #mm-scoreboard {
            background-color: #e9f5ff;
            border-left: 4px solid var(--accent-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 5px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            text-align: center;
        }
        .score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .score-item i {
            font-size: 12px;
            color: var(--primary-color);
        }
        .score-item h4 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #555;
        }
         .score-item p {
            margin: 0;
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-color);
        }

        #mm-life-calendars {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .life-calendar-wrapper {
            background: #fdfdfd;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .calendar-header {
            margin-bottom: 15px;
        }
        .calendar-header h4 { margin: 0 0 5px 0; font-size: 1.2em; }
        .calendar-header p { margin: 0; font-size: 0.9em; color: #666; }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(52, 1fr);
            gap: 3px;
        }
        .week-box {
            width: 100%;
            padding-bottom: 100%; /* For square aspect ratio */
            border-radius: 2px;
            background-color: #e0e0e0;
        }
        .week-box.past {
            background-color: #f0f0f0;
            position: relative;
        }
        .week-box.past::before,
        .week-box.past::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80%;
            height: 2px;
            background-color: #888888;
            transform-origin: center;
        }
        .week-box.past::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .week-box.past::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        .week-box.future { background-color: #d4edda; }
        .week-box.common { background-color: #28a745; }
        
        .week-box.non-common {
            background-color: #cccccc;
            position: relative;
        }
        .week-box.non-common::before,
        .week-box.non-common::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80%;
            height: 2px;
            background-color: #888888;
            transform-origin: center;
        }
        .week-box.non-common::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .week-box.non-common::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        
        #mm-filters {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            gap: 25px;
            flex-wrap: wrap;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            cursor: pointer;
        }
        .filter-checkbox input {
             cursor: pointer;
        }

        /* --- Qibla Compass styles --- */
        .compass-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px 0;
        }

        .compass {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='grad' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:rgb(245,245,245);stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:rgb(220,220,220);stop-opacity:1' /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23grad)' stroke='%23bbb' stroke-width='1'/%3E%3Ccircle cx='50' cy='50' r='45' fill='none' stroke='%23fff' stroke-width='1.5'/%3E%3Cpath d='M50 5 L50 10' stroke='%23333' stroke-width='1.5'/%3E%3Ctext x='50' y='16' font-size='6' text-anchor='middle' fill='%23333' font-weight='bold'%3EN%3C/text%3E%3Cpath d='M95 50 L90 50' stroke='%23333' stroke-width='1'/%3E%3Ctext x='86' y='51.5' font-size='4' text-anchor='middle' fill='%23333'%3EE%3C/text%3E%3Cpath d='M50 95 L50 90' stroke='%23333' stroke-width='1'/%3E%3Ctext x='50' y='87' font-size='4' text-anchor='middle' fill='%23333'%3ES%3C/text%3E%3Cpath d='M5 50 L10 50' stroke='%23333' stroke-width='1'/%3E%3Ctext x='14' y='51.5' font-size='4' text-anchor='middle' fill='%23333'%3EW%3C/text%3E%3C/svg%3E") no-repeat center center;
            background-size: contain;
            position: relative;
            transition: transform 0.1s linear;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .compass-arrow-qibla {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 85px solid #28a745;
            top: 15px;
            left: 50%;
            transform-origin: 50% 85px;
            transform: translateX(-50%) rotate(0deg);
            transition: transform 0.5s ease-out;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        .compass-arrow-qibla::after {
            content: '';
            position: absolute;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 85px solid #218838;
            top: 0;
            left: -12px;
            transform: scaleX(0.4);
            transform-origin: 50% 100%;
        }

        #qiblaStatus {
            text-align: center;
            font-weight: 500;
            color: #555;
            min-height: 40px;
            max-width: 80%;
            margin: 0 auto;
        }

        /* --- End Qibla Compass styles --- */
        
        /* Dark Mode for Tools Page */
        body.dark-mode .page-header h1 { color: var(--text-color) }
        body.dark-mode .page-header p { color: #ccc; }
        body.dark-mode .tool-card {
            background-color: #2b2b2b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        body.dark-mode .tool-card h3 { color: #f2f2f2; }
        body.dark-mode .tool-card p { color: #bbb; }
        body.dark-mode .tool-card i { color:var(--text-color) }
        
        body.dark-mode .icon-choice {
            background-color: #333;
            border-color: #555;
            color: #ccc;
        }
        body.dark-mode .icon-choice:hover {
            border-color: #5dade2;
        }
        body.dark-mode .icon-choice.selected {
            background-color: var(--text-color);
            color: #1a1a1a;
        }
        body.dark-mode .week-box.past {
            background-color: #444;
        }
        body.dark-mode .week-box.past::before,
        body.dark-mode .week-box.past::after {
            background-color: #e74c3c;
        }
        body.dark-mode .week-box.non-common {
            background-color: #555;
        }
        body.dark-mode .week-box.non-common::before,
        body.dark-mode .week-box.non-common::after {
            background-color: #999;
        }
        body.dark-mode #mm-filters {
            background-color: #222;
        }
        
        body.dark-mode .compass {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='grad_dark' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop offset='0%25' style='stop-color:rgb(60,60,60);stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:rgb(30,30,30);stop-opacity:1' /%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='48' fill='url(%23grad_dark)' stroke='%23111' stroke-width='1'/%3E%3Ccircle cx='50' cy='50' r='45' fill='none' stroke='%23555' stroke-width='1.5'/%3E%3Cpath d='M50 5 L50 10' stroke='%23eee' stroke-width='1.5'/%3E%3Ctext x='50' y='16' font-size='6' text-anchor='middle' fill='%23eee' font-weight='bold'%3EN%3C/text%3E%3Cpath d='M95 50 L90 50' stroke='%23eee' stroke-width='1'/%3E%3Ctext x='86' y='51.5' font-size='4' text-anchor='middle' fill='%23eee'%3EE%3C/text%3E%3Cpath d='M50 95 L50 90' stroke='%23eee' stroke-width='1'/%3E%3Ctext x='50' y='87' font-size='4' text-anchor='middle' fill='%23eee'%3ES%3C/text%3E%3Cpath d='M5 50 L10 50' stroke='%23eee' stroke-width='1'/%3E%3Ctext x='14' y='51.5' font-size='4' text-anchor='middle' fill='%23eee'%3EW%3C/text%3E%3C/svg%3E") no-repeat center center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 2px 4px rgba(0,0,0,0.4);
        }
        body.dark-mode #qiblaStatus {
            color: #ccc;
        }

        /* --- Popup/Modal Styles --- */
        .popup {
            display: none; 
            position: fixed; 
            z-index: 1002; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .popup-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        .popup-close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }

        .popup-close:hover,
        .popup-close:focus {
            color: black;
            text-decoration: none;
        }

        .popup-body {
            overflow-y: auto;
            padding-right: 15px; /* for scrollbar */
        }
        
        /* Specific popup content styling */
        .qibla-link-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            text-align: center;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1.2em;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        .qibla-link-btn:hover { background-color: #0056b3; }
        .qibla-link-btn i { margin-right: 10px; }

        .content-section { margin-bottom: 20px; }
        .content-section h4 { color: #333; border-bottom: 1px solid var(--text-color); padding-bottom: 5px; margin-bottom: 10px; }
        .content-section p { line-height: 1.6; }
        
        .reciter-list { list-style: none; padding: 0; }
        .reciter-item { align-items: center; margin-bottom: 15px; padding: 10px; background: var(--text-color); border-radius: 5px; }
        .reciter-info { display: flex; flex-direction: column; margin-left: 1; margin: 0 15px; }
        .reciter-info h5 { margin: 0 0 5px 0; }
        .reciter-info p { margin: 0; font-size: 0.9em; color: #666; }
        .reciter-item audio { height: 40px; width: 100%; }
    
        
        #prayerTimesContainer { text-align: center; }
        #prayerTimesContainer input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-right: 5px; }
        #prayerTimesContainer button { padding: 8px 12px; border-radius: 4px; border: none; background: var(--primary-color); color: white; cursor: pointer; }
        #prayerTimesResults { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .prayer-time { padding: 10px; background: var(--text-color); border-radius: 5px; border: 1px solid #eee; transition: background-color 0.4s, color 0.4s; }
        .prayer-time strong { display: block; }
        .prayer-time .time-display { font-size: 1.1em; font-weight: 500; margin: 4px 0; }
        .prayer-time .countdown { font-size: 0.85em; color: #555; height: 1.2em; display: block; transition: color 0.4s; }
        
        .prayer-time.passed {
            background-color: #e9ecef;
            color: #6c757d;
        }
        .prayer-time.passed .countdown {
            visibility: hidden;
        }

        .prayer-time.upcoming {
            /* Default for future prayers */
        }
        
        .prayer-time.next-upcoming {
            background-color: #28a745;
            color: white;
            border-color: #218838;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(40, 167, 70, 0.3);
        }
        .prayer-time.next-upcoming .countdown {
            color: #e0e0e0;
            font-weight: bold;
        }

        .prayer-legend {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            display: inline-block;
        }

        .article-card { background: #f9f9f9; border-radius: 5px; padding: 15px; margin-bottom: 10px; }
        .article-card h5 { margin: 0 0 10px 0; }
        .article-card p { margin: 0; }

        /* Dark Mode for popup */
        body.dark-mode .popup-content { background-color: #252525; color: #eee; }
        body.dark-mode .popup-header { border-bottom-color: #444; }
        body.dark-mode .popup-header h2 { color: var(--text-color); }
        body.dark-mode .popup-close { color: #888; }
        body.dark-mode .popup-close:hover { color: #eee; }
        body.dark-mode .content-section h4 { color: #f2f2f2; border-bottom-color: #555; }
        body.dark-mode .reciter-item { background: #333; }
        body.dark-mode .reciter-info p { color: #bbb; }
        body.dark-mode #prayerTimesContainer input { background: #444; border-color: #666; color: #eee; }
        body.dark-mode #prayerTimesContainer button:hover { background-color: #0056b3; }
        body.dark-mode .prayer-time { background: #333; border-color: #444; }
        body.dark-mode .prayer-time .countdown { color: #aaa; }
        body.dark-mode .article-card { background: #333; }
        body.dark-mode .prayer-time.passed {
            background-color: #2a2a2a;
            color: #777;
            border-color: #383838;
        }
        body.dark-mode .prayer-time.next-upcoming {
            background-color: #218838;
            color: white;
            border-color: #1c7430;
        }
         body.dark-mode .prayer-time.next-upcoming .countdown {
            color: #e0e0e0;
        }

        .mm-btnactive {
height: 1px;
width: 1px;    
background-color:white;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;        
}
    
.percent-tag {
    background-color: #28a745;
    color: white;
    font-size: 0.75em;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 6px;
    vertical-align: middle;
}


.h22{
    font-size: 1.3em;
    color: var(--primary-color);
    margin-bottom: 20px;
    display: block;
    text-align: justify;
}

.h23{
    font-size: 0.7em;
    color: var(--primary-color);
    margin-bottom: 20px;
    padding-bottom: 10px;
    display: block;
    text-align: justify;
}

body.dark-mode .h23 {
        font-size: 0.7em;
    color: var(--text-color)
    margin-bottom: 20px;
    display: block;
    text-align: justify;
}

body.dark-mode.arabic-name {
    position: absolute;
    right: 5%;
    font-size: 1.1em;
    color: var(--text-color);
    font-family: 'Amiri', serif; /* Optional: Arabic-styled font */
}

.arabic-name {
    position: absolute;
    right: 5%;
    font-size: 1.1em;
    font-family: 'Amiri', serif; /* Optional: Arabic-styled font */
}

</style>
</head>
<body>

        <!-- HEADER / TOP NAV -->
    <div class="top-nav">
        <button class="menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        <h1>
            <img src="img/logotitre.png" alt="Logo Quboor" class="logo">
        </h1>
        <div class="nav-right-controls">
            <button id="darkModeToggle" class="dark-mode-toggle-btn">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div id="mySidebar" class="sidebar">
        <span class="closebtn">&times;</span>
        <a href="search.html"><i class="fas fa-search"></i>Recherche</a>
        <a href="new.html"><i class="fas fa-user-plus"></i>Ajouter</a>
        <a href="mission.html"><i class="fas fa-tasks"></i>Missions</a>
        <a href="dons.html"><i class="fas fa-hand-holding-heart"></i>Projets et Dons</a>
        <a href="joinus.html"><i class="fas fa-users"></i>Rejoins-nous</a>
        <a href="tools.html"><i class="fas fa-tools"></i>Outils</a>
        <a href="contactus.html"><i class="fas fa-envelope"></i>Contact</a>    
        <a href="index.html"><i class="fas fa-home"></i>Accueil</a>
    </div>


    <!-- Main Content -->
    <div id="main">
        <div class="tools-container">
            <div class="tool-card" data-tool="recitations">
                <i class="fas fa-book-open"></i>
                <h3>Coran</h3>
            </div>
            <div class="tool-card" data-tool="douaa">
                <i class="fas fa-praying-hands"></i>
                <h3>Dou'as & Invocations</h3>
            </div>
                        <div class="tool-card" data-tool="qibla">
                <i class="fas fa-kaaba"></i>
                <h3>Qibla / Boussole</h3>
            </div>

            <div class="tool-card" data-tool="prieres">
                <i class="fas fa-mosque"></i>
                <h3>Horaires des Prières</h3>
            </div>
            <div class="tool-card" data-tool="mementoMori">
                <i class="fas fa-hourglass-half"></i>
                <h3>Memento Mori</h3>
            </div>
        </div>
    </div>

    <!-- Popup Modal -->
    <div id="toolPopup" class="popup">
        <div class="popup-content">
            <div class="popup-header">
                <h2 id="popupTitle"></h2>
                <span class="popup-close">&times;</span>
            </div>
            <div id="popupBody" class="popup-body">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar toggle functionality
            const menuBtn = document.querySelector('.menu-btn');
            const closeBtn = document.querySelector('.closebtn');
            const sidebar = document.getElementById("mySidebar");

            const toggleNav = () => {
                if (sidebar.style.left === "0px") {
                    sidebar.style.left = "-280px";
                } else {
                    sidebar.style.left = "0px";
                }
            };

            if (menuBtn) menuBtn.addEventListener('click', toggleNav);
            if (closeBtn) closeBtn.addEventListener('click', toggleNav);

            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const icon = darkModeToggle.querySelector('i');
                    if (isDarkMode) {
                        icon.classList.remove('fa-moon');
                        icon.classList.add('fa-sun');
                    } else {
                        icon.classList.remove('fa-sun');
                        icon.classList.add('fa-moon');
                    }
                });
            }

            // Quran Audio Player Logic
            const audioPlayer = document.getElementById('quran-player');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const volumeSlider = document.getElementById('volume-slider');

            if(playPauseBtn && audioPlayer && volumeSlider) {
                const playIcon = playPauseBtn.querySelector('i');

                playPauseBtn.addEventListener('click', () => {
                    if (audioPlayer.paused) {
                        audioPlayer.play().catch(e => console.error("Error playing audio:", e));
                    } else {
                        audioPlayer.pause();
                    }
                });

                audioPlayer.addEventListener('play', () => {
                    playIcon.classList.remove('fa-play');
                    playIcon.classList.add('fa-pause');
                });

                audioPlayer.addEventListener('pause', () => {
                    playIcon.classList.remove('fa-pause');
                    playIcon.classList.add('fa-play');
                });

                volumeSlider.addEventListener('input', () => {
                    audioPlayer.volume = volumeSlider.value;
                });
                audioPlayer.volume = volumeSlider.value;
            }

            // Tool Popup Logic
            const toolPopup = document.getElementById('toolPopup');
            const popupTitle = document.getElementById('popupTitle');
            const popupBody = document.getElementById('popupBody');
            const toolCards = document.querySelectorAll('.tool-card');
            const closePopupBtn = document.querySelector('.popup-close');

            function getPersonHtml(idPrefix, title) {
                const defaultDate = idPrefix === 'user' ? '2000-01-01' : (idPrefix === 'person-a' ? '1970-01-01' : '');
                const required = idPrefix === 'user' ? 'required' : '';
                
                return `
                    <div class="person-form" id="form-${idPrefix}">
                        <h5>${title}</h5>
                        <div class="form-group form-group-inline">
                            <label for="${idPrefix}-dob">Date de naissance</label>
                            <input type="date" id="${idPrefix}-dob" value="${defaultDate}" ${required}>
                        </div>
                        <div class="form-group-icons" data-key="gender" data-value="female">
                            <label>Genre</label>
                            <div class="icon-choices">
                                <button type="button" class="icon-choice selected" data-value="female" title="Femme"><i class="fas fa-female"></i></button>
                                <button type="button" class="icon-choice" data-value="male" title="Homme"><i class="fas fa-male"></i></button>
                            </div>
                        </div>
                        <div class="form-group-icons" data-key="quality" data-value="normal">
                             <label>Qualité de vie</label>
                            <div class="icon-choices">
                                <button type="button" class="icon-choice" data-value="sain" title="Saine"><i class="fas fa-smile-beam"></i></button>
                                <button type="button" class="icon-choice selected" data-value="normal" title="Normale"><i class="fas fa-meh"></i></button>
                                <button type="button" class="icon-choice" data-value="moyen" title="Moyenne"><i class="fas fa-frown"></i></button>
                            </div>
                        </div>
                        <div class="form-group-icons" data-key="disease" data-value="non">
                             <label>Maladie héréditaire?</label>
                            <div class="icon-choices">
                                <button type="button" class="icon-choice" data-value="oui" title="Oui"><i class="fas fa-check"></i></button>
                                <button type="button" class="icon-choice selected" data-value="non" title="Non"><i class="fas fa-times"></i></button>
                                <button type="button" class="icon-choice" data-value="nsp" title="Ne sais pas"><i class="fas fa-question"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }

            const toolContents = {
                qibla: {
                    title: 'Qibla / Boussole',
                    content: `
                        <div class="compass-container">
                                                     <h8><i class="fas fa-arrow-down"></i></h8>
   
                            <div class="compass" id="compass">
                                <div class="compass-arrow-qibla" id="qibla-arrow"></div>
                            </div>
                            <div id="qiblaStatus">Demande de permission de localisation...</div>
                        </div>
                        <div class="content-section">
                            <h4>Comment ça marche ?</h4>
                            <h23>La boussole utilise les capteurs de votre appareil pour indiquer la direction de la Qibla. Gardez l'appareil à plat et loin des objets métalliques. Une calibration peut être nécessaire en décrivant un "8" dans l'air.</h23>
                        </div>
                    `
                },
recitations: {
    title: 'Récitations du Coran',
    content: `
        <ul class="reciter-list">
            <li class="reciter-item" style="position: relative;">
                <div class="reciter-info">
                    <h5>Al-Fatiha <span class="arabic-name">الفاتحة</span></h5>
                </div>
                <audio controls preload="none" src="audio/alfatiha.mp3"></audio>
            </li>
            <li class="reciter-item" style="position: relative;">
                <div class="reciter-info">
                    <h5>Al-Baqara <span class="arabic-name">البقرة</span></h5>
                </div>
                <audio controls preload="none" src="audio/albaqara.mp3"></audio>
            </li>
            <li class="reciter-item" style="position: relative;">
                <div class="reciter-info">
                    <h5>Al-Imran <span class="arabic-name">آل عمران</span></h5>
                </div>
                <audio controls preload="none" src="audio/alimran.mp3"></audio>
            </li>                             
            <li class="reciter-item" style="position: relative;">
                <div class="reciter-info">
                    <h5>An-Nisa <span class="arabic-name">النساء</span></h5>
                </div>
                <audio controls preload="none" src="audio/annisa.mp3"></audio>
            </li>
            <li class="reciter-item" style="position: relative;">
                <div class="reciter-info">
                    <h5>Al-Mai'dah <span class="arabic-name">المائدة</span></h5>
                </div>
                <audio controls preload="none" src="audio/almaidah.mp3"></audio>
            </li>
        </ul>
    `
                },
                douaa: {
                    title: "Dou'as & Invocations",
                    content: `
                        <ul class="reciter-list">
                            <li class="reciter-item">
                                <div class="reciter-info">
                                    <h23>« Ô Allah, pardonne-lui et accorde-lui Ta miséricorde. Accorde-lui le salut et le pardon. Assure-lui une noble demeure. Elargis-lui sa tombe et lave-le avec l’eau, la neige et la grêle. Nettoie-le de ses péchés comme on nettoie le vêtement blanc de la saleté. Donne-lui en échange une demeure meilleure que la sienne et une épouse meilleure que la sienne. Fais-le entrer au Paradis et préserve-le du châtiment de la tombe (et du châtiment de l’Enfer) »</h23>
                                <br></br>
                                    </div>
                                <audio controls preload="none" src="audio/156.mp3"></audio>
                            </li>
                            <li class="reciter-item">
                                <div class="reciter-info">
                                    <h23>« Ô Allah, pardonne à nos vivants et à nos morts, aux présents et aux absents, aux jeunes et aux vieux, aux hommes et aux femmes. Ô Allah, celui d’entre nous que Tu maintiens en vie, fais-le vivre sur la voie de l’Islam et celui d’entre nous dont Tu as repris l’âme, fais-le mourir dans la foi. Ô Allah, ne nous prive pas de sa récompense et ne nous égare pas après sa mort. »</h23>
                                 <br></br>
                                    </div>
                                <audio controls preload="none" src="audio/157.mp3"></audio>
                            </li>
                            <li class="reciter-item">
                                <div class="reciter-info">
                                    <h23>« Ô Allah, untel fils d’untel est sous Ta protection et à l’abri de Ton voisinage. Préserve-le donc de la fitna de la tombe et du châtiment de l’enfer. Ô Toi digne de loyauté et de raison, pardonne-lui et accorde-lui Ta miséricorde car c’est Toi le Pardonneur, le Très Miséricordieux. »</h23>
                                <br></br>
                                </div>
                                <audio controls preload="none" src="audio/158.mp3"></audio>
                            </li>                             
                            <li class="reciter-item">
                                <div class="reciter-info">
                                    <h23>« Ô Allah, Il est Ton serviteur, fils de Ton serviteur (féminin), il a besoin de Ta miséricorde et Tu n’as nul besoin de son châtiment. S’il était bienfaiteur, augmente-lui le nombre de ses bonnes actions et s’il était pécheur alors pardonne-lui. »</h23>
                                </div>
                                <audio controls preload="none" src="audio/159.mp3"></audio>
                            </li>
                        </ul>
                    `
            },
                prieres: {
                    title: 'Horaires des Prières',
                    content: `
                        <div id="prayerTimesContainer">
                            <button id="getPrayerTimesBtn" class="qibla-link-btn" style="width: auto; background-color: var(--primary-color); display: inline-block; margin-bottom: 10px;"><i class="fas fa-crosshairs"></i> Afficher pour ma position</button>
                            <div id="prayerTimesResults"></div>
                            <div id="prayerTimesLegend" class="prayer-legend"></div>
                        </div>
                    `
                },
                mementoMori: {
                    title: 'Memento Mori',
                    content: `
                        <div id="mementoMoriContainer">
                            <div id="mm-step-1" class="mm-step active">
                                <h23>La projection repose sur les moyennes statistiques marocaines de 2025 mais ce ne sont que des chiffres — ni décrets divins, ni vérités absolues.
                                Votre santé, vos choix, et la volonté d’Allah façonnent votre chemin.
                                Ce qui importe dans cette démarche, ce n’est pas combien de temps il vous reste avant de mourir,
                                mais de visualiser le temps qu'il vous reste et comment vous choisissez de le vivre.</h23>
                                <div class="mm-form-grid">
                                    ${getPersonHtml('user', 'Commençons par vous')}
                                </div>
                                <div class="mm-navigation">
                                    <span></span>
                                    <button id="mm-step-1-next" class="mm-btn mm-btn-primary">Suivant <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>

                            <div id="mm-step-2" class="mm-step">
                                <h23>Indiquez maintenant les informations d’une personne qui vous est chère.
                                Cela peut être un parent, un(e) ami(e), ou toute âme avec qui vous partagez votre vie.
                                L’objectif est de visualiser le temps qu’il vous reste à traverser ensemble.
                                Non pas pour compter les jours, mais pour mieux en goûter la valeur.</h23>
                                <div class="mm-form-grid">
                                    ${getPersonHtml('person-a', 'Votre proche')}
                                </div>
                                <div class="mm-navigation">
                                     <button id="mm-step-2-back" class="mm-btn mm-btn-secondary"><i class="fas fa-arrow-left"></i> Précédent</button>
                                    <button id="mm-generate" class="mm-btn mm-btn-primary"><i class="fas fa-cogs"></i> Générer</button>
                                </div>
                            </div>

                            <div id="mm-step-3" class="mm-step">
                                <div id="mm-view-filters">
                                    <button class="mm-btnactive" data-view="commun"></button>
                                </div>
                                <div id="mm-scoreboard"></div>
                                <div id="mm-life-calendars"></div>
                                <div class="mm-navigation">
                                    <button id="mm-recalculate" class="mm-btn mm-btn-third"><i class="fas fa-sync-alt"></i> Recalculer</button>
                                </div>
                            </div>
                        </div>
                    `
                }
            };
            
            let qiblaAngle = 0;
            let deviceOrientationHandler;
            let prayerCountdownInterval = null;
            let mementoMoriAllPeopleData = [];

            function calculateQiblaDirection(latitude, longitude) {
                const kaabaLat = 21.4225 * Math.PI / 180;
                const kaabaLon = 39.8262 * Math.PI / 180;
                const userLat = latitude * Math.PI / 180;
                const userLon = longitude * Math.PI / 180;

                const lonDiff = kaabaLon - userLon;

                const y = Math.sin(lonDiff) * Math.cos(kaabaLat);
                const x = Math.cos(userLat) * Math.sin(kaabaLat) - Math.sin(userLat) * Math.cos(kaabaLat) * Math.cos(lonDiff);
                
                let angle = Math.atan2(y, x) * 180 / Math.PI;
                return angle;
            }
            
            function startQiblaCompass() {
                const statusDiv = document.getElementById('qiblaStatus');
                if (!('geolocation' in navigator) || !('DeviceOrientationEvent' in window)) {
                    statusDiv.innerHTML = "Désolé, votre navigateur ne supporte pas les fonctionnalités nécessaires (Géolocalisation ou Gyroscope).";
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    qiblaAngle = calculateQiblaDirection(latitude, longitude);

                    statusDiv.innerHTML = "Veuillez orienter le Nord de la boussole vers la flèche noire. La flèche verte vous indiquera alors la Qibla.";
                    
                    deviceOrientationHandler = (event) => {
                        let alpha = event.alpha; // Compass direction (0-360)
                        if (typeof event.webkitCompassHeading !== "undefined") {
                            alpha = event.webkitCompassHeading; // for iOS
                        }
                        
                        const compassElement = document.getElementById('compass');
                        const qiblaArrow = document.getElementById('qibla-arrow');

                        if (compassElement && qiblaArrow) {
                            // Rotate the whole compass to point North
                            compassElement.style.transform = `rotate(${-alpha}deg)`;
                            // Rotate the Qibla arrow to its calculated angle relative to North
                            qiblaArrow.style.transform = `translateX(-50%) rotate(${qiblaAngle}deg)`;
                        }
                    };

                    window.addEventListener('deviceorientation', deviceOrientationHandler);
                }, error => {
                    const statusDiv = document.getElementById('qiblaStatus');
                    statusDiv.innerHTML = `Erreur de localisation: ${error.message}. Impossible de déterminer la direction de la Qibla.`;
                });
            }
            
            function stopQiblaCompass() {
                 if (deviceOrientationHandler) {
                    window.removeEventListener('deviceorientation', deviceOrientationHandler);
                    deviceOrientationHandler = null;
                 }
            }

            function openPopup(tool) {
                if (toolContents[tool]) {
                    popupTitle.innerText = toolContents[tool].title;
                    popupBody.innerHTML = toolContents[tool].content;
                    toolPopup.style.display = 'flex';
                    if (tool === 'prieres') {
                        document.getElementById('getPrayerTimesBtn').addEventListener('click', fetchPrayerTimes);
                    }
                    if (tool === 'qibla') {
                        startQiblaCompass();
                    }
                    if (tool === 'mementoMori') {
                        initializeMementoMori();
                    }
                }
            }

            function closePopup() {
                stopQiblaCompass();
                stopPrayerCountdowns();
                toolPopup.style.display = 'none';
                popupBody.innerHTML = ''; // Clear content
                mementoMoriAllPeopleData = [];
            }

            function stopPrayerCountdowns() {
                if (prayerCountdownInterval) {
                    clearInterval(prayerCountdownInterval);
                    prayerCountdownInterval = null;
                }
            }

            toolCards.forEach(card => {
                card.addEventListener('click', () => {
                    openPopup(card.dataset.tool);
                });
            });

            closePopupBtn.addEventListener('click', closePopup);
            toolPopup.addEventListener('click', (event) => {
                if (event.target === toolPopup) {
                    closePopup();
                }
            });
            
            function initializeMementoMori() {
                const steps = document.querySelectorAll('.mm-step');
                const nextBtn = document.getElementById('mm-step-1-next');
                const backBtn = document.getElementById('mm-step-2-back');
                const generateBtn = document.getElementById('mm-generate');
                const recalculateBtn = document.getElementById('mm-recalculate');
                const container = document.getElementById('mementoMoriContainer');
                const viewFilters = document.getElementById('mm-view-filters');

                container.addEventListener('click', (e) => {
                    const iconChoice = e.target.closest('.icon-choice');
                    if(iconChoice) {
                        const parentGroup = iconChoice.closest('.form-group-icons');
                        const choices = parentGroup.querySelectorAll('.icon-choice');
                        choices.forEach(c => c.classList.remove('selected'));
                        iconChoice.classList.add('selected');
                        parentGroup.dataset.value = iconChoice.dataset.value;
                    }
                });

                if (viewFilters) {
                    viewFilters.addEventListener('click', (e) => {
                        const btn = e.target.closest('.mm-btn');
                        if (!btn) return;

                        viewFilters.querySelectorAll('.mm-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        const view = btn.dataset.view;
                        const userCal = document.getElementById('calendar-user');
                        const personACal = document.getElementById('calendar-person-a');

                        if (userCal) userCal.style.display = 'none';
                        if (personACal) personACal.style.display = 'none';

                        if (view === 'vous') {
                            if (userCal) userCal.style.display = 'block';
                        } else if (view === 'personne-a') {
                            if (personACal) personACal.style.display = 'block';
                        } else if (view === 'commun') {
                            if (userCal) userCal.style.display = 'block';
                            if (personACal) personACal.style.display = 'block';
                        }
                    });
                }

                const switchStep = (stepNumber) => {
                    steps.forEach(step => step.classList.remove('active'));
                    const targetStep = document.getElementById(`mm-step-${stepNumber}`);
                    if(targetStep) targetStep.classList.add('active');
                };

                nextBtn.addEventListener('click', () => {
                    // Simple check if user form is filled
                    if (document.getElementById('user-dob').value) {
                         switchStep(2);
                    } else {
                        alert("Veuillez entrer votre date de naissance.");
                    }
                });
                backBtn.addEventListener('click', () => switchStep(1));
                recalculateBtn.addEventListener('click', () => {
                    document.getElementById('mm-life-calendars').innerHTML = '';
                    document.getElementById('mm-scoreboard').innerHTML = '';
                    if (viewFilters) viewFilters.style.display = 'none';
                    mementoMoriAllPeopleData = [];
                    switchStep(1);
                });

                generateBtn.addEventListener('click', () => {
                    mementoMoriAllPeopleData = processMementoMoriData();
                    if(mementoMoriAllPeopleData.length > 0) {
                        renderMementoMoriResults(mementoMoriAllPeopleData);
                        switchStep(3);
                    }
                });
            }

            function processMementoMoriData() {
                const WEEKS_IN_YEAR = 52.1775;
                
                const calculateLifeExpectancy = (gender, quality, disease) => {
                    let base = gender === 'male' ? 74 : 77; // Morocco 2025 estimate
                    if (quality === 'sain') base += 5;
                    if (quality === 'moyen') base -= 5;
                    if (disease === 'oui') base -= 10;
                    if (disease === 'nsp') base -= 2;
                    return base;
                };

                const getPersonData = (idPrefix) => {
                    const dobValue = document.getElementById(`${idPrefix}-dob`).value;
                    
                    if (idPrefix !== 'user' && !dobValue) return null;
                    
                    if (idPrefix === 'user' && !dobValue) {
                         alert(`Veuillez entrer votre date de naissance.`);
                        return null;
                    }

                    const dobParts = dobValue.split('-'); // YYYY-MM-DD
                    const dob = new Date(dobParts[0], dobParts[1] - 1, dobParts[2]);

                     if (isNaN(dob.getTime())) { // Invalid date
                        if (idPrefix === 'user') alert(`Date de naissance invalide pour Vous.`);
                        return null;
                    }

                    const now = new Date();
                    const age = (now - dob) / (1000 * 60 * 60 * 24 * 365.25);
                    
                    const gender = document.querySelector(`#form-${idPrefix} [data-key='gender']`).dataset.value;
                    const quality = document.querySelector(`#form-${idPrefix} [data-key='quality']`).dataset.value;
                    const disease = document.querySelector(`#form-${idPrefix} [data-key='disease']`).dataset.value;

                    const lifeExpectancyYears = calculateLifeExpectancy(gender, quality, disease);
                    const expectedDeath = new Date(dob);
                    expectedDeath.setFullYear(dob.getFullYear() + Math.round(lifeExpectancyYears));
                    
                    const totalWeeks = Math.round(lifeExpectancyYears * WEEKS_IN_YEAR);
                    const weeksPassed = Math.round(age * WEEKS_IN_YEAR);

                    return {
                        id: idPrefix,
                        name: idPrefix === 'user' ? 'Vous' : (idPrefix === 'person-a' ? 'Personne A' : (idPrefix === 'person-b' ? 'Personne B' : 'Personne C')),
                        dob,
                        age: Math.floor(age),
                        expectedDeath,
                        lifeExpectancyYears: Math.round(lifeExpectancyYears),
                        totalWeeks,
                        weeksPassed,
                    };
                };

                const user = getPersonData('user');
                if (!user) {
                    alert("Veuillez entrer vos informations correctement.");
                    return [];
                }

                return [user, getPersonData('person-a')].filter(p => p !== null);
            }
            
            function renderMementoMoriResults(peopleData) {
                if (peopleData.length === 0) return;

                const scoreboard = document.getElementById('mm-scoreboard');
                const calendarsContainer = document.getElementById('mm-life-calendars');
                const viewFilters = document.getElementById('mm-view-filters');
                calendarsContainer.innerHTML = ''; // Clear previous calendars
                
                const user = peopleData.find(p => p.id === 'user');
                const personA = peopleData.find(p => p.id === 'person-a');
                
                let scoreHtml = '';
                const now = new Date();

                if (peopleData.length === 1) { // Only user data
                    viewFilters.style.display = 'none';
                    scoreHtml = `
`;
                    renderLifeCalendar(user, now, now, now);

                } else { // User and Person A
                    viewFilters.style.display = 'flex';
                    const earliestDeath = new Date(Math.min(user.expectedDeath, personA.expectedDeath));
                    const latestDeath = new Date(Math.max(user.expectedDeath, personA.expectedDeath));
                    
                    const commonWeeksRemaining = (earliestDeath > now) ? Math.floor((earliestDeath - now) / (1000 * 60 * 60 * 24 * 7)) : 0;
                    const survivorWeeks = (latestDeath > earliestDeath) ? Math.floor((latestDeath - earliestDeath) / (1000 * 60 * 60 * 24 * 7)) : 0;

scoreHtml = `
    <div class="score-item">
        <h4>Depuis ton premier souffle , Allah t’a accordé jusque là ${user.weeksPassed.toLocaleString()} semaines de vie. Chaque semaine est un souffle, une preuve que ton heure approche. Tu as déjà parcouru <span class="percent-tag">${Math.round((user.weeksPassed / user.totalWeeks) * 100)}%</span> du chemin que Dieu t’a tracé. A toi de prioritiser et d'optimiser le temps restant.</h4>
    </div>
    <div class="score-item">
        <h4>Ton proche, par la volonté d’Allah, a déjà traversé ${personA.weeksPassed.toLocaleString()} semaines dans ce bas monde. Riche d'histoires, d'anecdotes et d'expériences, cela représente <span class="percent-tag">${Math.round((personA.weeksPassed / personA.totalWeeks) * 100)}%</span> de son passage éphémère sur cette terre.</h4>
    </div>
    <div class="score-item">
        <h4>Il vous reste ${commonWeeksRemaining.toLocaleString()} semaines à partager. C’est <span class="percent-tag">${Math.round((commonWeeksRemaining / Math.min(user.totalWeeks, personA.totalWeeks)) * 100)}%</span> de ce temps commun que le destin vous accorde encore avant que chacun reprenne sa route vers l’éternité.</h4>
    </div>
`;
                    renderLifeCalendar(user, now, earliestDeath, latestDeath);
                }
                
                scoreboard.innerHTML = scoreHtml;

                // Reset filters to show "Commun" view
                viewFilters.querySelectorAll('.mm-btn').forEach(b => b.classList.remove('active'));
                viewFilters.querySelector('[data-view="commun"]').classList.add('active');
                const userCal = document.getElementById('calendar-user');
                const personACal = document.getElementById('calendar-person-a');
                if (userCal) userCal.style.display = 'block';
                if (personACal) personACal.style.display = 'block';
            }

            function renderLifeCalendar(person, now, earliestDeath, latestDeath) {
                const calendarsContainer = document.getElementById('mm-life-calendars');
                const calendarWrapper = document.createElement('div');
                calendarWrapper.className = 'life-calendar-wrapper';
                calendarWrapper.id = `calendar-${person.id}`;

                const isComparison = (earliestDeath.getTime() !== now.getTime() && latestDeath.getTime() !== now.getTime());
                
                let weekGridHtml = '';
                for (let i = 0; i < person.totalWeeks; i++) {
                    let weekClass = 'future'; // Default to light green
                    
                    const weekStartDate = new Date(person.dob.getTime() + (i * 7 * 24 * 60 * 60 * 1000));
                    
                    if (i < person.weeksPassed) {
                        weekClass = 'past';
                    } else if (isComparison) {
                        if (weekStartDate < earliestDeath) {
                            weekClass = 'common';
                        } else {
                            const isSurvivor = person.expectedDeath.getTime() === latestDeath.getTime();
                            if(isSurvivor) {
                                weekClass = 'non-common';
                            }
                        }
                    }

                    weekGridHtml += `<div class="week-box ${weekClass}" title="Semaine ${i + 1}"></div>`;
                }

                calendarWrapper.innerHTML = `
        <div class="calendar-header">
                <h22>Qu’est-ce que Memento Mori ?</h22>
                    <h23>Memento Mori est une expression latine qui signifie : « Souviens-toi que tu vas mourir. »
                    Elle nous vient de la Rome antique, où les généraux victorieux se faisaient rappeler, au sommet de leur gloire, qu’ils n’étaient que des mortels. Plus tard, dans la tradition musulmane, ce concept a évolué en rappel spirituel : nous sommes tous de passage sur cette terre, et chaque jour est un pas de plus vers l’éternité.</h23>
                    <h23>En islam, ce rappel est constant. Rapporté par At-Tirmidhi, Le Prophète ﷺ la qualifiait de « la destructrice des plaisirs » alors que 
                    dans le Coran, Allah nous rappelle que « Toute âme goûtera à la mort. »</h23>
                    <h23>Ce calendrier est une visualisation de ta vie en semaines, mais pas pour faire peur — pour te réveiller. Pour t’inviter à vivre avec conscience. À aimer mieux. À pardonner plus vite. À investir dans l’Au-delà. </h23>
                    </div>
                <h22>Comment l’interpréter ?</h22>
                   <h23>Chaque petit carré représente une semaine de ta vie. Elle peut sembler insignifiante seule, mais regarde-les ensemble : elles forment un tableau. Certaines semaines sont passées, d’autres sont à venir. Les semaines en vert représentent les semaines restantes que vous partagez en commun.</h23>
                   <br></br> 
                   <div class="week-grid">${weekGridHtml}</div>
                `;
                calendarsContainer.appendChild(calendarWrapper);
            }

            async function fetchPrayerTimes() {
                const resultsDiv = document.getElementById('prayerTimesResults');
                const legendDiv = document.getElementById('prayerTimesLegend');
                const getBtn = document.getElementById('getPrayerTimesBtn');

                if (!('geolocation' in navigator)) {
                    resultsDiv.innerHTML = '<p style="color: red;">La géolocalisation n\'est pas supportée par votre navigateur.</p>';
                    return;
                }

                resultsDiv.innerHTML = '<p>Chargement des horaires...</p>';
                legendDiv.innerHTML = '';
                getBtn.disabled = true;
                getBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Localisation...';

                navigator.geolocation.getCurrentPosition(async position => {
                    const { latitude, longitude } = position.coords;

                    try {
                        const response = await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=2`);
                        if (!response.ok) throw new Error('Impossible de récupérer les horaires pour votre position.');
                        const data = await response.json();
                        const timings = data.data.timings;
                        
                        stopPrayerCountdowns(); // Clear any existing interval

                        const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                        let resultsHTML = '';

                        prayerOrder.forEach(prayerName => {
                            const timeStr = timings[prayerName]; // e.g., "19:45"
                            resultsHTML += `
                                <div class="prayer-time" data-time="${timeStr}">
                                    <strong>${prayerName}</strong>
                                    <div class="time-display">${timeStr}</div>
                                    <div class="countdown"></div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = resultsHTML;


                        updatePrayerCountdowns(); // Initial call
                        prayerCountdownInterval = setInterval(updatePrayerCountdowns, 1000);

                    } catch (error) {
                        resultsDiv.innerHTML = `<p style="color: red;">Erreur: ${error.message}</p>`;
                    } finally {
                         getBtn.disabled = false;
                         getBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Afficher pour ma position';
                    }
                }, error => {
                     resultsDiv.innerHTML = `<p style="color: red;">Erreur de géolocalisation: ${error.message}.</p>`;
                     getBtn.disabled = false;
                     getBtn.innerHTML = '<i class="fas fa-crosshairs"></i> Afficher pour ma position';
                });
            }

            function updatePrayerCountdowns() {
                const now = new Date();
                let nextPrayerFoundThisCycle = false;

                document.querySelectorAll('.prayer-time').forEach(el => {
                    if (el.classList.contains('passed')) return;

                    const timeStr = el.dataset.time;
                    const [hour, minute] = timeStr.split(':');
                    const prayerTime = new Date();
                    prayerTime.setHours(parseInt(hour), parseInt(minute), 0, 0);

                    const diff = prayerTime - now;

                    if (diff < 0) {
                        el.classList.add('passed');
                        el.classList.remove('next-upcoming', 'upcoming');
                        el.querySelector('.countdown').textContent = '';
                    } else {
                        if (!nextPrayerFoundThisCycle) {
                            el.classList.add('next-upcoming');
                            el.classList.remove('upcoming');
                            nextPrayerFoundThisCycle = true;
                        } else {
                            el.classList.add('upcoming');
                            el.classList.remove('next-upcoming');
                        }

                        const totalSeconds = Math.floor(diff / 1000);
const hours = Math.floor(totalSeconds / 3600);
const minutes = Math.floor((totalSeconds % 3600) / 60);
const seconds = totalSeconds % 60;

el.querySelector('.countdown').textContent = `${hours}h ${minutes}m ${seconds.toString().padStart(2, '0')}s`;                    }
                });

                // If no future prayer was found, it means the last one just passed
                // we need to re-evaluate who is the "next" one (might be the one from the previous check)
                if(!nextPrayerFoundThisCycle){
                    // Find the first non-passed prayer and mark it as next.
                     const nextPrayerEl = document.querySelector('.prayer-time:not(.passed)');
                     if(nextPrayerEl){
                         nextPrayerEl.classList.add('next-upcoming');
                         nextPrayerEl.classList.remove('upcoming');
                     }
                }

            }

            async function fetchSurah(surahNumber) {
                const surahDiv = document.getElementById('surahContent');
                const transDiv = document.getElementById('surahTranslation');
                try {
                    const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/fr.salam`);
                    if (!response.ok) throw new Error('Erreur de chargement de la sourate.');
                    const data = await response.json();
                    const ayahs = data.data.ayahs;
                    surahDiv.innerHTML = ayahs.map(a => a.text).join('<br>');
                    transDiv.innerHTML = ayahs.map(a => `${a.numberInSurah}. ${a.text}`).join('<br>');
                } catch(e) {
                    surahDiv.innerHTML = "Impossible de charger la sourate.";
                    transDiv.innerHTML = "";
                }
            }

        });
    </script>
</body>
</html>